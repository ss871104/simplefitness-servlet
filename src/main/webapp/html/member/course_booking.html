<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/boostrap/bootstrap.min.css">
    <link rel="stylesheet" href="../../css/member/course_booking.css">
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script src='../../js/moment.min.js'></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../js/sweetalert2.all.js" type="text/javascript"></script>

    <!-- FullCalendar v3.8.1 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.8.1/fullcalendar.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.8.1/fullcalendar.print.css" rel="stylesheet"
        media="print">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.8.1/fullcalendar.min.js"></script>

    <title>預約團體課</title>

</head>

<body>

    <div class="topnav">

        <a class="img_link" href="http://localhost:5500/html/home.html">
            <img class="logoImg" src="../../img/Simple_Fitness-logos_white.png" alt="">
        </a>

        <ul class="list-inline">
            <li class="dropdown">
                <a class="topnavBtn" id="home" href="http://localhost:5500/html/home.html">
                    <img class="icon" src="../../img/home.png" alt="" title="首頁">
                </a>
                <div class="dropdown-content">
                    <ul>
                        <li><a href="#">最新消息</a></li>
                        <li><a href="#">場館資訊</a></li>
                        <li><a href="#">課程資訊</a></li>
                        <li><a href="#">收費方式</a></li>
                    </ul>
                </div>
            </li>
            <li>
                <a class="topnavBtn" id="cart" href="#cart">
                    <img class="icon" src="../../img/cart.png" alt="" title="購物車">
                </a>
            </li>
            <li>
                <a class="topnavBtn" id="notice" href="#notice">
                    <img class="icon" src="../../img/bell.png" alt="" title="通知中心">
                </a>
            </li>
            <li class="dropdown">
                <a class="topnavBtn" id="user" href="#user">
                    <img class="icon" src="../../img/user.png" alt="" title="會員">
                </a>
                <div class="dropdown-content">
                    <ul>
                        <li><a href="#">登出</a></li>
                    </ul>
                </div>
            </li>
        </ul>
    </div>

    <div class="side-menu">
        <ul class="nav">
            <li>
                <a href="#">
                    <i class="fa fa-users" aria-hidden="true"></i>
                    會員資料編輯
                </a>
            </li>
            <li>
                <a href="http://localhost:5500/html/booking.html">
                    <i class="fa fa-gavel" aria-hidden="true"></i>
                    課程預約
                </a>
                <ul>
                    <li>
                        <a href="http://localhost:5500/html/course_booking.html">
                            預約團課
                        </a>
                    </li>
                    <li>
                        <a href="http://localhost:5500/html/coach_booking.html">
                            預約教練課
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            我的預約
                        </a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#">
                    <i class="fa fa-coins" aria-hidden="true"></i>
                    租借用品
                </a>
                <ul>
                    <li>
                        <a href="#">
                            我的租借清單
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>


    <div class="course_booking">
        <div class="contentTitle">
            <p><i class="fa-solid fa-list-check"> 預約團課</i></p>
            <select class="select" id="classLocation" name="classLocation">
                <option value="" selected>選擇場館</option>
            </select>
            <select class="select" id="classType" name="classType">
                <option value="" selected>選擇課程</option>
            </select>
            <div class="titleBtn">
                <button type="submit" id="queryBooking" class="btn_submit">查詢課程</button>
            </div>
        </div>
        <div class="contentBody">
            <div id="example" class="calendarArea"></div>
        </div>
    </div>




</body>
<script>
    var mem_id = 1;

    $(document).ready(function () {

        loadGymList();

        loadTeamClassList();

        //**參數設定開始**************************************************************************/
        //會員編號(先寫死)

        //SWAL按鈕設定
        swal.setDefaults({
            //確認按鈕顯示文字
            confirmButtonText: "確定",
            //取消按鈕顯示文字
            cancelButtonText: "取消",
            // 畫面鎖定設定
            allowOutsideClick: false
        });

        $("#example").fullCalendar({
            // 參數設定
            header: { // 頂部排版
                left: "prev,next today", // 左邊放置上一頁、下一頁和今天
                center: "title", // 中間放置標題
                right: "" // 右邊放置月、周、天
            },
            // defaultDate: "2022-09-12", // 起始日期
            weekends: true, // 顯示星期六跟星期日
            //editable: true,  // 啟動拖曳調整日期
            //allDay: true
            locale: 'zh-cn', //中文设置
            timeFormat: "HH:mm",
            eventClick: function (date, event, view) {
                swal({
                    title: "請確認是否預約",
                    html: "課程名稱:" + date.course + "<br>"
                        + "課程場館:" + date.gym + "<br>"
                        + "課程教練:" + date.emp + "<br>"
                        + "課程時間:" + moment(date.start).format("YYYY-MM-DD") + "\n" + moment(date.start).format("HH:mm"),
                    type: "info",//success,error,warning
                    showCancelButton: true//顯示取消按鈕
                }).then(
                    function (result) {
                        //點擊確認事件
                        if (result.value) {
                            checkBooking(date.resourse);
                            getCourseList();
                        }
                        else {
                            swal("預約取消", "太可惜拉~", "warning");
                            getCourseList()
                        }
                    });//end then
            }
        });
        //**參數設定結束**************************************************************************/

        //查詢按鈕觸發事件
        $("#queryBooking").click(function () {
            if (!$("#classLocation").val()) {
                swal("提醒~", "未選擇場館，請選擇欲預約場館~", "warning");

            } else if (!$("#classType").val()) {
                swal("提醒~", "未選擇課程，請選擇欲預約課程~", "warning");
            } else {
                //取得可預約課程清單
                getCourseList();
            }

        })
        function checkBooking(item) {

            $.ajax({
                url: "http://localhost:8080/simplefitness-servlet/courseBooking/BookCourseServlet",
                type: "POST",
                data: JSON.stringify({
                    courseId: item.courseId,
                    courseListId: item.courseListId,
                    gymId: item.gymId,
                    coursebookStatus: "1",
                    memId: mem_id
                }),
                // async: false,
                contentType: 'application/json; charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    // console.log(data)
                    if (data) {
                        swal("預約成功", "太棒拉~", "success");
                        getCourseList();
                    }
                    else {
                        swal("預約失敗", "太雖拉~", "error");
                    }
                }
            });
            getCourseList();

        }
        //取得可預約課程清單
        function getCourseList() {
            $.ajax({
                url: "http://localhost:8080/simplefitness-servlet/courseBooking/SearchCourseServlet",
                type: "POST",
                data: JSON.stringify({
                    gymId: $('#classLocation').val(),
                    courseListId: $('#classType').val(),
                    memId: mem_id//目前寫死
                }),
                // async: false,
                contentType: 'application/json; charset=UTF-8',
                dataType: "json",
                success: function (data) {
                    console.log(data)
                    showCalendarEvent(data);
                }
            });
        }
        // 取得健身房下拉選單資訊
        function loadGymList() {
            $.ajax({
                url: "http://localhost:8080/simplefitness-servlet/gym/getAllGym",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var optionStr = "";
                    data.forEach(gym => optionStr += '<option value="' + gym.gymId + '">' + gym.gymName + '</option>');
                    console.log(optionStr);
                    $("#classLocation").empty();
                    $("#classLocation").append('<option value="">選擇場館</option>');
                    $('#classLocation').append(optionStr);
                }
            })


        }
        // 取得團課下拉選單資訊
        function loadTeamClassList() {
            $.ajax({
                url: "http://localhost:8080/simplefitness-servlet/courseList/getAllCourse",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var optionStr = "";
                    data.forEach(course => optionStr += '<option value="' + course.courseListId + '">' + course.courseName + '</option>');
                    console.log(optionStr);
                    $("#classType").empty();
                    $("#classType").append('<option value="">選擇課程</option>');
                    $('#classType').append(optionStr);
                }
            })
        }

        function showCalendarEvent(courses) {
            $('#example').fullCalendar('removeEvents')
            console.log("清空日曆")
            courses.forEach(course => {
                var newEvent = new Object();
                newEvent.title = course.courseName;
                newEvent.course = course.courseName;
                newEvent.gym = course.gymName;
                newEvent.emp = course.empName;
                newEvent.start = moment(course.startTime).format();
                newEvent.allDay = false;
                newEvent.color = "#7ccc9e"
                newEvent.resourse = course;
                $('#example').fullCalendar('renderEvent', newEvent);

            });
            console.log("填入日曆")


        }
    });


</script>




</html>